generator client {
  provider        = "prisma-client-js"
  output          = "../app/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pg_trgm(map: "pg_trgm"), unaccent, uuidOssp(map: "uuid-ossp")]
}

enum Role {
  ADMIN
  USER
}

enum FileType {
  EXCEL
  PDF
}

enum MatchType {
  EXACT
  FUZZY
  MANUAL
  NONE
}

enum EmailConfigMode {
   API
   SMTP
}

enum EmailTemplateType {
   COMPARISON
   GENERAL
}

enum EmailStatus {
   PENDING
   SENT
   FAILED
}

enum EstimateSelectionMode {
   CHEAPEST
   FASTEST
   CUSTOM
}

model User {
    id                 String   @id @default(uuid())
    email              String   @unique
    name               String
    password           String
    role               Role     @default(USER)
    isActive           Boolean  @default(true) @map("is_active")
    mustChangePassword Boolean  @default(false) @map("must_change_password")
    createdAt          DateTime @default(now()) @map("created_at")
    updatedAt          DateTime @updatedAt @map("updated_at")

    estimateEmails     EstimateEmail[]
    auditLogs          AuditLog[]
    uploadedPriceLists PriceList[]        @relation("UploadedPriceLists")
    comparisonDrafts   ComparisonDraft[]
    estimates          Estimate[]

    @@map("users")
}

model Customer {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  phone     String?
  company   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  emailLogs  EmailLog[]
  estimates  Estimate[]

  @@map("customers")
}

model Laboratory {
  id          String    @id @default(uuid())
  name        String
  code        String    @unique
  city        String?
  address     String?
  phone       String?
  email       String?
  contactName String?   @map("contact_name")
  isActive    Boolean   @default(true) @map("is_active")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  priceLists         PriceList[]
  testMappingEntries TestMappingEntry[]

  @@map("laboratories")
}

model PriceList {
  id           String   @id @default(uuid())
  laboratoryId String   @map("laboratory_id")
  uploadedById String?  @map("uploaded_by_id")
  fileName     String   @map("file_name")
  fileType     FileType @map("file_type")
  fileSize     Int      @map("file_size")
  isActive     Boolean  @default(true) @map("is_active")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  laboratory Laboratory @relation(fields: [laboratoryId], references: [id])
  uploadedBy User?      @relation("UploadedPriceLists", fields: [uploadedById], references: [id])
  tests      Test[]

  @@map("price_lists")
}

model Test {
  id             String  @id @default(uuid())
  priceListId    String  @map("price_list_id")
  name           String
  code           String?
  price          Float
  unit           String?
  category       String?
  description    String?
  turnaroundTime String? @map("turnaround_time")
  tubeType       String? @map("tube_type")
  isActive       Boolean @default(true) @map("is_active")

  priceList PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)

  @@index([name])
  @@index([code])
  @@map("tests")
}

model TestMapping {
  id            String   @id @default(uuid())
  canonicalName String   @unique @map("canonical_name")
  description   String?
  category      String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  entries        TestMappingEntry[]

  @@map("test_mappings")
}

model TestMappingEntry {
  id            String    @id @default(uuid())
  testMappingId String    @map("test_mapping_id")
  laboratoryId  String    @map("laboratory_id")
  localTestName String    @map("local_test_name")
  matchType     MatchType @map("match_type")
  similarity    Float     @default(0)
  price         Float?
  createdAt     DateTime  @default(now()) @map("created_at")

  testMapping TestMapping @relation(fields: [testMappingId], references: [id], onDelete: Cascade)
  laboratory  Laboratory  @relation(fields: [laboratoryId], references: [id])

  @@unique([testMappingId, laboratoryId])
  @@map("test_mapping_entries")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  details   Json?
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model EmailLog {
  id         String      @id @default(uuid())
  toEmail    String      @map("to_email")
  subject    String
  status     EmailStatus @default(SENT)
  source     String      @default("system")
  error      String?
  customerId String?     @map("customer_id")
  createdAt  DateTime    @default(now()) @map("created_at")

  customer Customer? @relation(fields: [customerId], references: [id])

  @@map("email_logs")
}

model ComparisonDraft {
  id             String   @id @default(uuid())
  name           String
  userId         String   @map("user_id")
  testMappingIds String[] @map("test_mapping_ids")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@map("comparison_drafts")
}

model EmailSettings {
  id             String          @id @default(uuid())
  mode           EmailConfigMode @default(SMTP)
  smtpHost       String?         @map("smtp_host")
  smtpPort       Int?            @map("smtp_port")
  smtpUser       String?         @map("smtp_user")
  smtpPass       String?         @map("smtp_pass")
  apiKey         String?         @map("api_key")
  fromEmail      String?         @map("from_email")
  fromName       String?         @map("from_name")
  companyLogoUrl String?         @map("company_logo_url")
  signatureHtml  String?         @map("signature_html")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  @@map("email_settings")
}

model LoginAttempt {
  id        String   @id @default(uuid())
  email     String
  success   Boolean  @default(false)
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email, createdAt])
  @@map("login_attempts")
}

model EmailTemplate {
  id        String            @id @default(uuid())
  type      EmailTemplateType
  name      String
  subject   String
  htmlBody  String            @map("html_body")
  isDefault Boolean           @default(false) @map("is_default")
  variables Json?
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  @@map("email_templates")
}

model Estimate {
    id                String   @id @default(uuid())
    estimateNumber    String   @unique @map("estimate_number")
    customerId        String?  @map("customer_id")
    createdById       String   @map("created_by_id")

    // Estimate content
    testMappingIds    String[] @map("test_mapping_ids")
    selections        Json?    // Multi-lab selections per test: { testMappingId: labId }
    customPrices      Json     @default("{}")   // Custom price overrides: { "${testId}-${labId}": price }
    selectionMode     EstimateSelectionMode? @map("selection_mode")  // CHEAPEST, FASTEST, or CUSTOM (null = single lab)

    // Calculation
    totalPrice        Float    @map("total_price")
    subtotal          Float?

    // Status & dates
    status            String   @default("DRAFT")  // DRAFT, SENT, ACCEPTED, REJECTED
    notes             String?
    validUntil        DateTime? @map("valid_until")
    sentAt            DateTime? @map("sent_at")

    createdAt         DateTime @default(now()) @map("created_at")
    updatedAt         DateTime @updatedAt @map("updated_at")

    // Relations
    customer          Customer? @relation(fields: [customerId], references: [id])
    createdBy         User      @relation(fields: [createdById], references: [id])
    emails            EstimateEmail[]

    @@map("estimates")
}

model EstimateEmail {
   id          String      @id @default(uuid())
   estimateId  String      @map("estimate_id")
   sentById    String      @map("sent_by_id")
   toEmail     String      @map("to_email")
   subject     String
   message     String?
   status      EmailStatus @default(PENDING)
   sentAt      DateTime?   @map("sent_at")
   error       String?
   createdAt   DateTime    @default(now()) @map("created_at")

   estimate Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
   sentBy   User     @relation(fields: [sentById], references: [id])

   @@map("estimate_emails")
}

